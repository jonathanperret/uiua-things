TestCases â† {
  # literals
  $ 123
  $ "hello"
  $ @x
  $ @ğŸ˜‡
  $ []
  $ [i 0 1 2]
  $ {}
  $ [[4 5 6][7 8 9]]
  $ ["x" "y"]
  $ {"x" "yz"}
  $ i
  $ NaN
  $ [NaN]
  $ {NaN}
  $ comptime(â„‚ NaN NaN)
  $ comptime(map [1] [2])
  $ [{}]
  $ {[]}
  $ @\\t
  $ -@\\x00 @Z

  # stack operations
  $ .2
  $ ,1 2
  $ :1 2
  $ ;1 2 3

  # monadic pervasive
  $ âˆ˜ 3
  $ Â¬ 3
  $ Â± 3
  $ Â¯ 1
  $ âŒµ `1
  $ âˆš 4
  $ â—‹ 0
  $ âŒŠ 1234.56
  $ âŒˆ 1.234
  $ â… 5.678

  # dyadic pervasive
  $ =1 2
  $ â‰ 1 2
  $ <1 2
  $ â‰¤1 2
  $ >1 2
  $ â‰¥1 2
  $ +2 4
  $ -2 5
  $ *2 4
  $ Ã·2 6
  $ â—¿2 7
  $ â¿2 3
  $ â‚™2 8
  $ â†§3 8
  $ â†¥3 8
  $ âˆ 1 0
  $ â„‚1 2

  # monadic array
  $ â§»5
  $ â–³5
  $ â‡¡5
  $ âŠ¢[1 2 3]
  $ â‡Œ[1 2 3]
  $ â™­5
  $ Â¤5
  $ â‹¯27
  $ â‰.[[1 2] [3 4] [5 6]]
  $ â[6 2 7 0 Â¯1 5]
  $ â–[6 2 7 0 Â¯1 5]
  $ âŠš [1 0 0 1 0 1 1 0]
  $ âŠ›[7 7 8 0 1 2 0]
  $ âŠ[7 7 8 0 1 2 0]
  $ âŠ”â–¡5
  $ â‹• "17"

  # dyadic array
  $ â‰ [0 1 2] [0 1 2]
  $ âŠŸ 1 2
  $ âŠ‚ 1 2
  $ âŠ 2 [8 3 9 2 0]
  $ âŠ¡ 2 [8 3 9 2 0]
  $ â†¯ [2 3] [1 2 3 4 5 6]
  $ â˜‡ 0 â†¯[2 3 3]â‡¡18
  $ â†™ 3 [8 3 9 2 0]
  $ â†˜ 3 [8 3 9 2 0]
  $ â†»1 â‡¡5
  $ â—«2 .â‡¡4
  $ â–½ [1 0 2 3 1] [8 3 9 2 0]
  $ âŒ• 5 [1 8 5 2 3 5 4 5 6 7]
  $ âˆŠ 2 [1 2 3]
  $ âŠ— 2 [1 2 3]

  # misc
  $ â¤"ok" 1
  $ gen0
  $ deal0 [1 2 3 4 5]
  $ regex "h([io])" "hihaho"
  $ utf "hello!"
  $ â‰¥0 tag
  $ type 5
  $ Â±now
  $ - . âš‚

  # constants
  $ Î·
  $ Ï€
  $ Ï„
  $ âˆ

  # maps
  $ map 1\_2 3\_4
  $ insert 1 2 {}
  $ has 1 map 1\_2 3\_4
  $ get 1 1\_2 3\_4
  $ remove 3 map 1\_2 3\_4

  # System
  $ &sc
  $ &cd "/tmp"
  $ &fras "/tmp/data1.tmp" &fwa "/tmp/data1.tmp" "data"
  $ &frab "/tmp/data2.tmp" &fwa "/tmp/data2.tmp" "data"
  $ &ims [[1 0][0 1]]
  $ type &args

  # Switch
  $ (10|20)0
  $ (10 20|20 30)1
  $ (*2|*4+)1 10 90
  $ (*2|*4+)0 10 90
  $ (*2|*4+)0 10 90 99
  $ (|4.3 1 2 3 â‹…â‹…â‹…;||3.2 5 6 â‹…â‹…;)0 10 20 30 40
  $ (|4.3 1 2 3 â‹…â‹…â‹…;||3.2 5 6 â‹…â‹…;)1 10 20 30 40

  # Format
  $ $"\_" 100
  $ $"[x=\_ y=\_]" 100 200

  # PushTemp, PopTemp
  $ âŠ™100 200
  $ âŠ™âŠ™âˆ˜ 100 200 300
  $ âŠ™â‹…â‹…âŠ™100 200 300 400 500
  $ âŠ™â‹…â‹…âŠ™âˆ˜ 100 200 300 400 500
  $ âŠƒ(Ã—2|+1) 100
  $ âŠƒ(Ã—2+|+1) 100 200 300
  $ âŠƒ(Ã—2|âŠ™âˆ˜) 10 100 1000

  # CopyToTemp, CopyFromTemp, DropTemp
  $ âœ(Ã—10) â… 1.234
  $ âœâŠ¢(Ã—2) [1 2 3]
  $ âŠ¢â‡Œ[1 2 3]

  # Call
  $ F â† â¤.1 Â§ F

  # BeginArray, EndArray, TouchStack
  $ {. "hello"}
  $ [. 123]
  $ [. {. 123}]
  $ [. 123 456] 789
  $ {;1} 789
  $ [;1] 789
  $ {âŠ™âˆ˜} 1 2 3
  $ [âˆ˜] 1
  $ [=] 1 2
  $ [:] 1 2
  $ [,] 1 2
  $ [insert 5 6] map [1 2] [3 4]
  $ [.] 1
  $ [$"hello \_"] 123

  # inv_where
  $ Â°âŠš[0 3 5 6]

  # inverse_bits
  $ Â°â‹¯ [1 0 1]

  # under now
  $ >0 âœnow (+1 2)

  # unrerank
  # $ âœ(â˜‡0)âˆ˜ [[2 3][4 5]]

  # reduce
  $ /+ [1 2 3 4 5]
  $ /- [1 2 3 4 5]
  $ /- [1 2 3 4 5]
  $ /(Ã—+1) [1 2 3 4 5]
  $ /âŠ‚ [[0 1][2 3]]
  $ /âŠ‚ â†¯[2 2 4]â‡¡16
  $ /+ [123]
  $ /+ 123
  $ /Ã— â†¯3_0 0
  # $ /+ []
  # $ /Ã— []
  # $ /â†¥ []
  # $ /â†§ []
  # $ /âˆ  []

  # fold
  # $ âˆ§+ [1 2 3] 10
  # $ âˆ§+ [] 10
  # $ âˆ§(âŠƒ+(Ã—âŠ™â‹…âˆ˜)) +1â‡¡5 0 1
  # $ âˆ§(âŠƒ+(Ã—âŠ™â‹…âˆ˜))âŠ™(0 1) +1â‡¡5
  # $ âˆ§âŠƒ(+âŠ™â‹…âˆ˜)(Ã—â‹…âŠ™â‹…âˆ˜) [1 2 3] [4 5 6] 0 1
  # $ âˆ§(âŠ‚âŠ‚) [1 2 3] 4 []
  # $ â‡Œâˆ§(âŠ‚+âŠ™(âŠ¢.)) âŠƒâ†˜â†™1 [1 2 3 4]

  # scan
  # $ \+   [1 2 3 4]
  # $ \-   [1 2 3 4]
  # $ \(-:) [1 2 3 4]
  # $ â–½\â†§â‰ @ . "Hello World!"
  # $ âŠ•â–¡\+=@    . "Everyday man's on the block"
  # $ âŠ•â–¡\+â†»Â¯1=@ . "Everyday man's on the block"

  # each
  # $ âˆµ(âŠŸ.) [1 2 3 4]
  # $ âˆµâŠ‚ [1 2 3] [4 5 6]
  # $ âˆµâŠ‚ [1 2] [[4 5] [6 7]]
  $  + [1 2 3] [4 5 6]

  # rows
  $  /+ [[1 2 3] [4 5 6] [7 8 9]]
  # $ â‰¡/+ [[1 2 3] [4 5 6] [7 8 9]]
  # $ â‰¡/+ [[1 2] [3 4]] [5 6]
  # $ â‰¡âŠ‚  [[1 2] [3 4]] [5 6]
  # $ â‰¡âŠ‚ [1 2 3] 4
  # $ â‰¡âŠ‚ 1 [2 3 4]
  # $ â‰¡(âŠ‚âŠ‚) 1 [2 3 4] 5
  # $ â‰¡âŠ‚ Â¤  [1 2 3] [4 5 6]
  # $ â‰¡âŠ‚ âŠ™Â¤ [1 2 3] [4 5 6]

  # table
  # $ âŠ+ [1 2 3] [4 5 6 7]
  # $ âŠâŠ‚ [1 2] [3 4]
  # $ â–³âŠ+ [1 2] [3 4 5]
  # $ â–³âŠâŠ‚ [1 2] [3 4 5]
  # $ â–³âŠ+ [[1 2 3] [4 5 6]] [7 8 9 10]
  # $ â–³âŠâŠ‚ [[1 2 3] [4 5 6]] [7 8 9 10]

  # cross
  # $ âŠ âŠ‚ ,,[[7 8] [9 10]][[1 2] [3 4] [5 6]]
  # $ âŠ (âŠ‚âŠ‚) [1 2] [3 4] [5 6]
  # $ /âŠ‚ âŠ (âŠ‚âŠ‚) âŠ™Â¤ [1 2] [3 4] [5 6]

  # repeat
  $ â¥(+2)5 99 200
  $ â¥(+2)0 99 200
  $ â¥(âŠ‚2)5 []
  $ â¥âŠ‚3 [] 1 2 3

  # transpose_n
  $ â‰â‰[1 2]
  $ Â°(â‰â‰)[1 2]

  # group
  # $ âŠ•âˆ˜ [0 2 2 1 0 1] [1 2 3 4 5 6]
  # $ âŠ•âŠ‚ [] [0 2 2 1 0 1] [1 2 3 4 5 6]
  # $ âŠ•â–¡ [0 1 0 2 1 1] [1 2 3 4 5 6]
  # $ âŠ•{âŠ¢:â§».} âŠ›.âŠâ. $ Count the characters is this string
  # $ âœâŠ•â–¡â‰¡â‡Œ â‰ @ . $ These are some words

  # partition
  # $ âŠœâˆ˜ [0 0 2 2 1 1 3 3] [1 2 3 4 5 6 7 8]
  # $ âŠœâŠ‚ [] [0 0 2 2 1 1 3 3] [1 2 3 4 5 6 7 8]
  # $ âŠœâ–¡ [0 2 3 3 3 0 1 1] [1 2 3 4 5 6 7 8]
  # $ âŠœâ–¡ â‰ @ . $ Hey there friendo
  # $ âœâŠœâ–¡â‡Œ â‰ @ . $ These are some words

  # unpack
  # $ âŠ/âŠ‚ {"a" "bc" "def"}
  # $ âŠ(Â¯â–¡3)
  # $ âŠ( â–¡3)

  # do
  # $ â¢(Ã—2)(<1000) 1
  # $ â¢âŠ‚(Â¬âˆŠ,,(+1Ã—3|Ã·2)=0â—¿2.âŠ¢.) [7]
  # $ â¢(Ã—3)(<100)  1
  # $ â¢(Ã—3)(<100.) 1
  # $ â¢(âŠƒ(Ã—2)âŠ‚)(<100) 1 []

  # fill
  # $ â¬š0â†™ 7 [8 3 9 2 1]
  # $ â¬šÏ€â†™ Â¯6 [1 2 3]
  # $ â¬š42â†™ 4 [[1 2 3] [4 5 6]]
  # $ â¬š0âŠŸ 1 [2 3]
  # $ â¬š0âŠŸ [1 2] [3 4 5 6]
  # $ â¬š0âŠŸ [1 2 3] [[4 5] [6 7]]
  # $ â¬š0âŠ‚ 1 [[2 3 4] [5 6 7]]
  # $ â¬š0âŠ‚ [[1 2] [3 4]] [5 6 7]
  # $ â¬š0[1 [2 3] [4 5 6]]
  # $ â¬š0+ [1 2 3] [10 9 8 7 6 5]
  # $ â¬š0\âŠ‚ [1 2 3 4 5]
  # $ â¬š@ âŠœâˆ˜â‰ @ . "No â–¡ needed!"
  # $ â¬šâˆâŠ [3 7 0] [8 3 9 2 0]
  # $ â¬š0â–½ â‰¡/>â—«2. [1 8 0 2 7 2 3]
  # $ â¬š0â†¯ [3 5] â‡¡9
  # $ â¬š0â†» 2 [1 2 3 4 5]
  # $ â¬šâˆ˜+ 100 [1 2 3 4] [5 6]
  # $ â¬š0(â†»1 â‡¡5 â¬š[]â†»3 â‡¡5 â†»2 â‡¡5)

  # try
  # $ â£(+1 2)$"Error:  "
  # $ â£(+@a @b)$"Error:  "

  # this
  # recur
  # $ â†¬((|1 Ã—â†«-1.|1)<2.) 5

  # bind
  # $ bind(âŠ‚ b + a c) 1 2 3

  # memo
  # $ âˆµmemo(+âŒŠÃ—10âš‚)[1 1 2 2 3 3]

  # spawn
  # wait
  # $ wait spawnâ‡¡ 10

  # send
  # recv
  # tryrecv

  # dump
  # $ dumpâŠ¢ [1 2 3] 4 [5 6 7]
}

WithTempFile â† &i "tempfile.ua" "WithTempFile"

Replace â† âŠ/âŠ‚ â†˜1 â™­â‰¡âŠ‚ {âˆ˜}: âŠ¢â‡Œâ‰ regex âŠƒ(âŠ‚"(.*?)"|âŠ‚: âŠ™â‹…âˆ˜|â‹…âˆ˜)
---
â¤âŠƒâ‹…âˆ˜â‰ "azzbzz" Replace "cc" "zz" "accbcc"
---

Escape â† â†˜Â¯1 âŠ/âŠ‚ â†˜1â™­â‰¡âŠ‚ âŠƒ(â–¡âŠ‚@\\|âŠ•â–¡âœâ–½Â¯:\+.=, âŠ™(âŠ‚:@.))
---
â¤âŠƒâ‹…âˆ˜â‰ "a\\b\\\"c" Escape @" "a\\b\"c"
â¤âŠƒâ‹…âˆ˜â‰ "a\\\\b\"c" Escape @\\ "a\\b\"c"
---

GetProgramPath â† â£(Â°â–¡âŠ¢&args|â‹…"")
DirName â† â†˜ Â¯+1âŠ—@/ â‡Œ.

MakeCheckProgram â† (
  âŠƒ(
    â¤"must run with absolute path for tests"=@/âŠ¢. GetProgramPath
    $"_/vm-test-helper.ua" DirName
  | âŠœâ–¡â‰ @Â§.
    âŠƒ(
      (""|âŠ/$"_\n_") Â±â§». â†˜Â¯1
    | Â°â–¡âŠ¢â‡Œ
    )
  | $"\"_\"" Replace @Â§ "\\n" Escape @" Escape @\\
  )
  $ # Experimental!
  $ Check â† &i "_" "Check"
  $ _
  $ {
  $ _
  $ }
  $ Check: _

)

# expr -- success
AutoCheck â† (|1
  MakeCheckProgram.
  # programtext expr
  âœWithTempFile (&runc {"uiua" "run" "--no-format" âˆ˜})
  # -- exitcode stdout stderr
  âŠƒ(
    â†§ âˆ©(=0) âŠ™â‹…â§» # success is exitcode=0 && empty stderr

  | â‹…âŠ‚ # join stderr to stdout

  )
  # -- success output expr
  (
    &p$"âŒ _\n_":
    0
  | # &pâ‹…$"âœ… _"
    1
  )
)

ThreadCount â† NumProcs

Parallel! â† (
  âŠ/âŠ‚ â–½â‰¡â§». â‰¡(â–¡â‰¡wait â‰¡spawn^1 â–½â‰¡(Â¬â‰â–¡0).) â¬š(â–¡0)â†¯ âŠŸ :ThreadCount Â¯1
)

RunTests â† &pâœnow(
  âŠ/âŠ‚ â‰¡(âœÂ°â–¡(âŠœâ–¡ â‰ @\n.)) TestCases
  Parallel!(AutoCheck Â°â–¡)
  &pâŠ¡:"ğŸ˜­ğŸ‰" /â†§
)

RunTests
